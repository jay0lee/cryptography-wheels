name: Build Cryptography Wheels

on: [push, workflow_dispatch]

jobs:
  build_wheels:
    defaults:
      run:
        shell: bash

    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
      
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-15-intel, macos-26, ubuntu-24.04-arm, ubuntu-24.04, windows-2025, windows-11-arm ]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Clone Cryptography (Latest Stable)
        run: |
          # Clone the official repo
          git clone https://github.com/pyca/cryptography.git
          cd cryptography
          
          # Find the latest stable tag (excluding alpha/beta/rc)
          # 'git describe' finds the most recent tag reachable from a commit
          latest_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
          
          # Checkout that tag
          git checkout $latest_tag
          echo "Building Cryptography Version: $latest_tag"

      - name: Install Rust (Windows only)
        # Windows runners might need an explicit Rust toolchain update for ARM64 builds
        if: runner.os == 'Windows'
        uses: dtolnay/rust-toolchain@df9545d60616606550658b163e0e47be792cdb69
        with:
          targets: aarch64-pc-windows-msvc

      - name: Build wheels
        env:
          CIBW_SKIP: "pp* cp36-* cp37-*"
          CIBW_BEFORE_BUILD: "pip install setuptools-rust"
        run: |
          cd cryptography
          python -m pip install cibuildwheel
          python -m cibuildwheel --output-dir wheelhouse

      - name: Upload Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
